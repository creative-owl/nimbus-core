"use strict";var e=require("mongoose"),t=require("jsonwebtoken"),r=require("uuid");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=s(e),n=s(t);class i extends Error{constructor(e){super(e),this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)}}const o={autoIndex:!1,bufferCommands:!1,serverSelectionTimeoutMS:3e3};class c{constructor(e){return this.event=e,this.format()}format(){let e={};return e.url=this.event.resource,e.body=JSON.parse(this.event.body),e.method=this.event.httpMethod,e.headers=this.event.headers,e.parameters=this.event.queryStringParameters,e.pathParameters=this.event.pathParameters,e.multiValueParameters=this.event.multiValueQueryStringParameters,e}}class u{json(e,t,r){let s={"Content-Type":"application/json; charset=utf-8","Access-Control-Allow-Methods":process.env.CORS_ALLOWED_METHODS,"Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key","Access-Control-Allow-Origin":process.env.CORS_ALLOWED_ORIGIN};return{statusCode:e,headers:Object.assign(s,r),body:JSON.stringify(t)}}}class l extends Error{constructor(e){super(e),this.name=this.constructor.name,this.type=e.toString(),Error.captureStackTrace(this,this.constructor)}}const d={algorithm:"HS256",expiresIn:"1h"};class h{static refresh(e){try{const t=this.stripDates(this.validate(e));return this.generate(t)}catch(e){throw new l(e)}}static validate(e){try{return n.default.verify(e.split(" ")[1],process.env.JWT_SHARED_SECRET,d)}catch(e){throw new l(e)}}static generate(e){try{return n.default.sign(e,process.env.JWT_SHARED_SECRET,d)}catch(e){throw new l(e)}}static stripDates(e){return delete e.iat,delete e.exp,e}}const m=new(0,a.default.Schema)({_id:{type:String,default:()=>r.v4()},name:{type:String,unique:!0,required:!0},description:{type:String,required:!0}},{timestamps:{createdAt:"created_at",updatedAt:"updated_at"},collection:"permissions"});var p=a.default.model("Permissions",m);const S=new(0,a.default.Schema)({_id:{type:String,default:()=>r.v4()},role_id:{type:String,required:!0},permission_id:{type:String,required:!0}},{timestamps:{createdAt:"created_at",updatedAt:"updated_at"},collection:"roles_permissions"});var f=a.default.model("RolesPermissions",S);const v={GET:process.env.PERMISSION_GET,POST:process.env.PERMISSION_POST,PATCH:process.env.PERMISSION_PATCH,DELETE:process.env.PERMISSION_DELETE};class y{async hasAccess(e){if("Authorization"in e.headers==!1)return{status:"failure",errors:{authorization:{message:"Authorization token was not found!",rule:"must-authorize"}}};let t=await class{static async hasPermission(e,t){try{const r=await h.validate(e),s=await this.getPermissions(r.user.role),a=await this.getPermissionIdFromName(t);for(let e in s)if(s[e].permission_id===a._id)return!0}catch(e){return e.type}return!1}static async getPermissions(e){try{return await f.find({role_id:e})}catch(e){throw new Error(e)}}static async getPermissionIdFromName(e){try{return await p.findOne({name:e})}catch(e){throw new Error(e)}}}.hasPermission(e.headers.Authorization,v[e.method]);return!0!==t?"JsonWebTokenError: invalid token"===t?{status:"failure",errors:{jwt:{message:"Please check that your JWT is valid!",rule:"must-have-valid-token"}}}:{status:"failure",errors:{role:{message:"Please check that you have correct role to preform this opperation",rule:"must-have-role"}}}:void 0}}const w=new(0,a.default.Schema)({_id:{type:String,default:()=>r.v4()},name:{type:String,unique:!0,required:!0},description:{type:String,default:null,required:!1}},{timestamps:{createdAt:"created_at",updatedAt:"updated_at"},collection:"roles"});var g=a.default.model("Roles",w);var E={db:class{static async connect(){return await a.default.connect(process.env.DB_CONNECTION_STRING,o).catch((async e=>Promise.reject(new i(e))))}static async disconnect(){return await a.default.disconnect()}},Http:class{async route(e,t,r){let s=e.httpMethod.toLowerCase(),a=new c(e),n=new u;if(class{static stringToBool(e){return!0===e||"true"===e}}.stringToBool(process.env.AUTH_ENABLED)&&"OPTIONS"!==a.method){let e=await(new y).hasAccess(a);if(e)return n.json(401,e)}return await(new r)[s](a,n)}},Roles:g,Controller:class{success(e){return{status:"success",attributes:e}}validation(e){return{status:"failure",errors:e}}exception(e){return{status:"failure",errors:{[e.name]:{message:e.message,stack:e.stack}}}}},JwtHandler:h,Permissions:p,RolesPermissions:f};module.exports=E;
