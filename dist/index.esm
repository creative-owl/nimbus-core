import e from"mongoose";import t from"jsonwebtoken";import{v4 as r}from"uuid";class s extends Error{constructor(e){super(e),this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)}}const a={autoIndex:!1,bufferCommands:!1,serverSelectionTimeoutMS:3e3};class o{constructor(e){return this.event=e,this.format()}format(){let e={};return e.url=this.event.resource,e.body=JSON.parse(this.event.body),e.method=this.event.httpMethod,e.headers=this.event.headers,e.parameters=this.event.queryStringParameters,e.pathParameters=this.event.pathParameters,e.multiValueParameters=this.event.multiValueQueryStringParameters,e}}class i{json(e,t,r){let s={"Content-Type":"application/json; charset=utf-8","Access-Control-Allow-Methods":process.env.CORS_ALLOWED_METHODS,"Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key","Access-Control-Allow-Origin":process.env.CORS_ALLOWED_ORIGIN};return{statusCode:e,headers:Object.assign(s,r),body:JSON.stringify(t)}}}class n extends Error{constructor(e){super(e),this.name=this.constructor.name,this.type=e.toString(),Error.captureStackTrace(this,this.constructor)}}const c={algorithm:"HS256",expiresIn:"1h"};class u{static refresh(e){try{const t=this.stripDates(this.validate(e));return this.generate(t)}catch(e){throw new n(e)}}static validate(e){try{return t.verify(e.split(" ")[1],process.env.JWT_SHARED_SECRET,c)}catch(e){throw new n(e)}}static generate(e){try{return t.sign(e,process.env.JWT_SHARED_SECRET,c)}catch(e){throw new n(e)}}static stripDates(e){return delete e.iat,delete e.exp,e}}const l=new(0,e.Schema)({_id:{type:String,default:()=>r()},name:{type:String,unique:!0,required:!0},description:{type:String,required:!0}},{timestamps:{createdAt:"created_at",updatedAt:"updated_at"},collection:"permissions"});var d=e.model("Permissions",l);const h=new(0,e.Schema)({_id:{type:String,default:()=>r()},role_id:{type:String,required:!0},permission_id:{type:String,required:!0}},{timestamps:{createdAt:"created_at",updatedAt:"updated_at"},collection:"roles_permissions"});var m=e.model("RolesPermissions",h);const p={GET:process.env.PERMISSION_GET,POST:process.env.PERMISSION_POST,PATCH:process.env.PERMISSION_PATCH,DELETE:process.env.PERMISSION_DELETE};class S{async hasAccess(e){if("Authorization"in e.headers==!1)return{status:"failure",errors:{authorization:{message:"Authorization token was not found!",rule:"must-authorize"}}};let t=await class{static async hasPermission(e,t){try{const r=await u.validate(e),s=await this.getPermissions(r.user.role),a=await this.getPermissionIdFromName(t);for(let e in s)if(s[e].permission_id===a._id)return!0}catch(e){return e.type}return!1}static async getPermissions(e){try{return await m.find({role_id:e})}catch(e){throw new Error(e)}}static async getPermissionIdFromName(e){try{return await d.findOne({name:e})}catch(e){throw new Error(e)}}}.hasPermission(e.headers.Authorization,p[e.method]);return!0!==t?"JsonWebTokenError: invalid token"===t?{status:"failure",errors:{jwt:{message:"Please check that your JWT is valid!",rule:"must-have-valid-token"}}}:{status:"failure",errors:{role:{message:"Please check that you have correct role to preform this opperation",rule:"must-have-role"}}}:void 0}}const y=new(0,e.Schema)({_id:{type:String,default:()=>r()},name:{type:String,unique:!0,required:!0},description:{type:String,default:null,required:!1}},{timestamps:{createdAt:"created_at",updatedAt:"updated_at"},collection:"roles"});var w=e.model("Roles",y);var v={db:class{static async connect(){return await e.connect(process.env.DB_CONNECTION_STRING,a).catch((async e=>Promise.reject(new s(e))))}static async disconnect(){return await e.disconnect()}},Http:class{async route(e,t,r){let s=e.httpMethod.toLowerCase(),a=new o(e),n=new i;if(class{static stringToBool(e){return!0===e||"true"===e}}.stringToBool(process.env.AUTH_ENABLED)&&"OPTIONS"!==a.method){let e=await(new S).hasAccess(a);if(e)return n.json(401,e)}return await(new r)[s](a,n)}},Roles:w,Controller:class{success(e){return{status:"success",attributes:e}}validation(e){return{status:"failure",errors:e}}exception(e){return{status:"failure",errors:{[e.name]:{message:e.message,stack:e.stack}}}}},JwtHandler:u,Permissions:d,RolesPermissions:m};export{v as default};
